/**
 * This file was auto-generated by the Titanium Module SDK helper for Android
 * TiDev Titanium Mobile
 * Copyright TiDev, Inc. 04/07/2022-Present
 * Licensed under the terms of the Apache Public License
 * Please see the LICENSE included with this distribution for details.
 *
 */
package com.inzori.stripe;

import android.app.Activity;
import org.appcelerator.kroll.KrollModule;
import org.appcelerator.kroll.annotations.Kroll;
import org.appcelerator.kroll.KrollDict;
import org.appcelerator.kroll.KrollFunction;
import org.appcelerator.titanium.TiApplication;
import org.appcelerator.kroll.common.Log;
import android.net.Uri;

import androidx.activity.ComponentActivity;

import com.stripe.android.identity.*;

@Kroll.module(name="Stripe", id="com.inzori.stripe")
public class StripeModule extends KrollModule
{

	// Standard Debugging variables
	private static final String LCAT = "StripeModule";
	private String ephemeralKeySecret = "";
	private String verificationSessionId = "";
	private IdentityVerificationSheet identityVerificationSheet;

	private static Activity activity;
	// You can define constants with @Kroll.constant, for example:
	// @Kroll.constant public static final String EXTERNAL_NAME = value;

	public StripeModule()
	{
		super();
	}

	@Kroll.onAppCreate
	public static void onAppCreate(TiApplication app)
	{
		Log.w(LCAT, "inside onAppCreate");
		// put module init code that needs to run when the application is created
		activity = app.getCurrentActivity();
	}

	// Methods
	@Kroll.method
	public void startVerification(KrollDict options)
	{
		Log.w(LCAT, "startVerification called");
		verificationSessionId = options.containsKey("verificationSessionId") ? (String) options.get("verificationSessionId") : "";
		ephemeralKeySecret = options.containsKey("ephemeralKeySecret") ? (String) options.get("ephemeralKeySecret") : "";
		KrollFunction onComplete = (KrollFunction) options.get("onComplete");

		identityVerificationSheet = IdentityVerificationSheet.Companion.create(
				(ComponentActivity) TiApplication.getAppCurrentActivity(),
			// pass your brand logo by creating it from local resource or
			// Uri.parse("https://path/to/a/logo.jpg")
			new IdentityVerificationSheet.Configuration(Uri.parse("https://files.stripe.com/files/MDB8YWNjdF8xMDQ5RVE0NmdmQ0VhM1F2fGZfbGl2ZV9MbnRzRjA2Nk1MVnh0TjB0dkhwYnFSY2M00BC2xHgEr")),
			verificationFlowResult -> {
				// handle verificationResult
				KrollDict eventData = new KrollDict();
				Log.d(LCAT, verificationFlowResult.toString());
//				if (verificationFlowResult instanceof Completed) {
//					// The user has completed uploading their documents.
//					// Let them know that the verification is processing.
//
//					eventData.put("success",true);
//					eventData.put("type","status");
//					eventData.put("status","flowCompleted");
//					eventData.put("message","Verification Flow Completed!");
//					onComplete.callAsync(getKrollObject(), eventData);
//					Log.d(LCAT, "Verification Flow Completed!");
//				} else if (verificationFlowResult instanceof Canceled) {
//					// The user did not complete uploading their documents.
//					// You should allow them to try again.
//					eventData.put("success",true);
//					eventData.put("type","status");
//					eventData.put("status","flowCanceled");
//					eventData.put("message","Verification Flow Canceled!");
//					onComplete.callAsync(getKrollObject(), eventData);
//					Log.d(LCAT, "Verification Flow Canceled!");
//				} else  if (verificationFlowResult instanceof Failed) {
//					// If the flow fails, you should display the localized error
//					// message to your user using throwable.getLocalizedMessage()
//					eventData.put("success",false);
//					eventData.put("type","status");
//					eventData.put("status","flowFailed");
//					eventData.put("message","Verification Flow Failed!");
//					onComplete.callAsync(getKrollObject(), eventData);
//					Log.d(LCAT, "Verification Flow Failed!");
//				}
			}
		);

		identityVerificationSheet.present(
				verificationSessionId,
				ephemeralKeySecret
		);
}


}

